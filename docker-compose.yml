services:
  frontend:
    build:
      context: ./src/main_module/visualization
      dockerfile: DockerFile
      target: dev
    ports:
      - "5173:5173"
    volumes:
      - ./src/main_module/visualization:/app
      - frontend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development

  jekyll:
    image: ruby:3.1
    working_dir: /usr/src/docs
    volumes:
      - ./docs:/usr/src/docs
      - jekyll_gems:/usr/local/bundle
    environment:
      - JEKYLL_ENV=development
      - BUNDLE_PATH=/usr/local/bundle
    ports:
      - "4000:4000"
      - "35729:35729"
    command: >
      bash -c "
        echo 'Bundler check...' &&
        bundle check || bundle install &&
        echo 'Starting Jekyll server...' &&
        bundle exec jekyll serve --source . --destination ./_site --host 0.0.0.0 --port 4000 --watch --force_polling --livereload
      "

  jekyll-build:
    image: ruby:3.1
    working_dir: /usr/src/docs
    volumes:
      - ./docs:/usr/src/docs
      - jekyll_gems:/usr/local/bundle
    environment:
      - JEKYLL_ENV=development
      - BUNDLE_PATH=/usr/local/bundle
    command: >
      bash -c "
        echo 'Bundler check...' &&
        bundle check || bundle install &&
        echo 'Building Jekyll site...' &&
        bundle exec jekyll build --source . --destination ./_site
      "

  lychee:
    image: lycheeverse/lychee:latest
    volumes:
      - ./docs/_site:/site
    command: --verbose --no-progress --max-redirects 5 --retry-wait-time 2 --base http://localhost:4000 /site

volumes:
  jekyll_gems:
  frontend_node_modules:
